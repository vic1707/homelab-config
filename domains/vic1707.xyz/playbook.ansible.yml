---
- name: Manage {{ domain }}
  hosts: localhost
  connection: local
  gather_facts: false

  vars:
    domain: vic1707.xyz
    cf_auth_token: "{{ lookup('community.general.passwordstore', 'domains/vic1707.xyz/api-key.cloudflare', subkey='key') }}"
    cf_account_name: vic1707

  vars_files:
    - dns-records/protonmail.ansible.yml
    - dns-records/brevo.ansible.yml
    - dns-records/homelab.ansible.yml

  tasks:
    - name: Zone SSL security
      ansible.builtin.include_role:
        name: linuxhq.cloudflare.ssl
      vars:
        cf_ssl:
          - zone_id: "{{ _cf_zone_id[domain] }}"
            mode: strict # origin_pull?
            always_use_https: true
            min_tls_version: 1.3
            automatic_https_rewrites: true
            opportunistic_encryption: true

    - name: Zone security
      ansible.builtin.include_role:
        name: linuxhq.cloudflare.security
      vars:
        cf_security:
          - zone_id: "{{ _cf_zone_id[domain] }}"
            security_level: high
            challenge_ttl: 900 # 15min
            browser_check: true

    - name: DNS records
      ansible.builtin.include_role:
        name: linuxhq.cloudflare.dns
      vars:
        cf_dns:
          - zone: "{{ domain }}"
            records: "{{
                protonmail_dns_records_map
                | combine(brevo_dns_records_map, list_merge='append')
                | combine(homelab_dns_records_map, list_merge='append')
                | moreati.jq.jq('to_entries | map(.value[] + { type: .key })')
              }}"
