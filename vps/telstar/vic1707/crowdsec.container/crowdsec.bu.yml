# yaml-language-server: $schema=https://raw.githubusercontent.com/Relativ-IT/Butane-Schemas/Release/Butane-Schema.json
---
variant: fcos
version: 1.6.0

storage:
  directories:
    - path: /srv/vic1707/containers/crowdsec
      mode: 0755
      user:
        name: vic1707
      group:
        name: vic1707

    - path: /home/vic1707/.config/containers/crowdsec
      mode: 0755
      user:
        name: vic1707
      group:
        name: vic1707
  files:
    - path: /home/vic1707/.config/containers/systemd/crowdsec.container
      mode: 0400
      contents:
        inline: |
          [Unit]
          Description=Crowdsec Quadlet

          [Container]
          Image=docker.io/crowdsecurity/crowdsec:v1.6.11-debian
          ContainerName=crowdsec
          Network=tunnel.network
          NoNewPrivileges=true
          DropCapability=ALL
          Tmpfs=/var/lib/crowdsec/data
          PublishPort=127.0.0.1:8080:8080
          Environment="TZ=Europe/Paris"
          Environment="BOUNCER_KEY_caddy={{ .CROWDSEC_CADDY_BOUNCER_API_KEY }}"
          Environment="BOUNCER_KEY_firewall={{ .CROWDSEC_FIREWALL_BOUNCER_API_KEY }}"
          Environment="ENROLL_KEY={{ .CROWDSEC_API_KEY }}"
          Environment="USE_WAL=true"
          Environment="ENROLL_INSTANCE_NAME=telstar"
          Environment="COLLECTIONS=crowdsecurity/linux crowdsecurity/sshd crowdsecurity/caddy crowdsecurity/http-cve crowdsecurity/whitelist-good-actors crowdsecurity/appsec-virtual-patching crowdsecurity/appsec-generic-rules"
          Volume=/srv/vic1707/containers/crowdsec:/etc/crowdsec:Z,rw
          Volume=/home/vic1707/.config/containers/crowdsec/acquis.yaml:/etc/crowdsec/acquis.yaml:Z,rw
          Volume=CrowdsecLogs.volume:/var/log:ro
          Volume=/var/log/journal:/run/log/journal:ro

          Notify=healthy
          HealthCmd=cscli lapi status
          HealthInterval=30s
          HealthTimeout=5s
          HealthRetries=5
          HealthStartPeriod=180s

          [Service]
          Restart=always
          # Podman handles it via Healthcheck and Notify=healthy
          TimeoutStartSec=infinity
          ExecStartPre=/usr/bin/bash -c "until [ -f /run/restore-complete ]; do sleep 1; done"
          ExecStartPre=/usr/bin/bash -c "until [ -f /run/user/1001/crowdsec-volume-ready ]; do sleep 1; done"
          # needed by the bounder, I think
          ExecStartPost=/usr/bin/touch /run/user/1001/crowdsec-ready

          [Install]
          WantedBy=default.target
      user:
        name: vic1707
      group:
        name: vic1707
    - path: /home/vic1707/.config/containers/systemd/CrowdsecLogs.volume
      mode: 0400
      contents:
        inline: |
          [Volume]
          VolumeName=CrowdsecLogs

          [Service]
          ExecStartPost=/usr/bin/podman run --rm -v CrowdsecLogs:/mnt docker.io/library/alpine mkdir -p /mnt/caddy
          ExecStartPost=/usr/bin/touch /run/user/1001/crowdsec-volume-ready
      user:
        name: vic1707
      group:
        name: vic1707
    - path: /home/vic1707/.config/containers/crowdsec/acquis.yaml
      mode: 0400
      contents:
        local: ./acquis.yaml
      user:
        name: vic1707
      group:
        name: vic1707
