# yaml-language-server: $schema=https://raw.githubusercontent.com/Relativ-IT/Butane-Schemas/Release/Butane-Schema.json
---
variant: fcos
version: 1.6.0

storage:
  directories:
    - path: /srv/vic1707/containers/caddy
      mode: 0755
      user:
        name: vic1707
      group:
        name: vic1707
    - path: /home/vic1707/.config/containers/caddy
      mode: 0755
      user:
        name: vic1707
      group:
        name: vic1707

  files:
    - path: /home/vic1707/.config/containers/caddy/Caddyfile
      mode: 0400
      contents:
        local: ./Caddyfile
      user:
        name: vic1707
      group:
        name: vic1707
    - path: /home/vic1707/.config/containers/systemd/caddy.container
      mode: 0400
      contents:
        inline: |
          [Unit]
          Description=Caddy Quadlet
          After=crowdsec.container

          [Container]
          Image=ghcr.io/vic1707/homelab/telstar-caddy:latest
          ContainerName=caddy
          Network=tunnel.network
          ReadOnly=true
          DropCapability=ALL
          AddCapability=NET_BIND_SERVICE
          NoNewPrivileges=true
          Environment="TZ=Europe/Paris"
          Environment="CLOUDFLARE_API_TOKEN={{ .CLOUDFLARE_API_TOKEN }}"
          Environment="CROWDSEC_CADDY_BOUNCER_API_KEY={{ .CROWDSEC_CADDY_BOUNCER_API_KEY }}"
          PublishPort=443:443
          Volume=/home/vic1707/.config/containers/caddy/Caddyfile:/etc/caddy/Caddyfile:Z,ro
          Volume=/srv/vic1707/containers/caddy:/data/caddy:Z,rw
          Mount=type=volume,source=CrowdsecLogs.volume,subpath=/caddy,destination=/var/log/caddy
          UserNS=keep-id
          # User=vic1707

          Notify=healthy
          HealthCmd=wget --spider --quiet --tries=1 --timeout=5 http://localhost:9999/health
          HealthInterval=30s
          HealthTimeout=5s
          HealthRetries=5
          HealthStartPeriod=30s

          [Service]
          Restart=always
          # Podman handles it via Healthcheck and Notify=healthy
          TimeoutStartSec=infinity
          ExecStartPre=/usr/bin/bash -c "until [ -f /run/restore-complete ]; do sleep 1; done"

          [Install]
          WantedBy=default.target
      user:
        name: vic1707
      group:
        name: vic1707
