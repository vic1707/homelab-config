# {{ $SSH_PORT := gopass "telstar/ssh-port" | strings.TrimSpace | required }}
# {{ $STORAGEBOX_USER := gopass "backups/backupiter/telstar.account" "user" | strings.TrimSpace | required }}
# {{ $STORAGEBOX_PASS := gopass "backups/backupiter/telstar.account" "pass" | strings.TrimSpace | required }}

# {{ $ARCH:= "arm64" }} # TODO: from env
# {{ $ENABLE_BACKUP := conv.ToBool .Env.ENABLE_BACKUP }}
###### Debug SELinux

# sudo ausearch -m avc -ts recent
### Print allow policy
# sudo ausearch -m avc -ts recent | grep <thing> | audit2allow -m TMP
---
# yaml-language-server: $schema=https://raw.githubusercontent.com/Relativ-IT/Butane-Schemas/Release/Butane-Schema.json
variant: fcos
version: 1.6.0

storage:
  links:
    # Timezone config
    - path: /etc/localtime
      target: ../usr/share/zoneinfo/Europe/Paris

  # Base container storage path
  directories:
    - path: /etc/selinux/custom-policies
    - path: /srv/vic1707
      mode: 0755
      user:
        name: vic1707
      group:
        name: vic1707
    - path: /srv/vic1707/containers
      mode: 0755
      user:
        name: vic1707
      group:
        name: vic1707
    - path: /srv/vic1707/containers/caddy
      mode: 0755
      user:
        name: vic1707
      group:
        name: vic1707
    - path: /home/vic1707/.config/containers/caddy
      mode: 0755
      user:
        name: vic1707
      group:
        name: vic1707
    # Path for vic1707's systemd units
    - path: /home/vic1707/.config
      mode: 0755
      user:
        name: vic1707
      group:
        name: vic1707
    - path: /home/vic1707/.config/systemd
      mode: 0755
      user:
        name: vic1707
      group:
        name: vic1707
    - path: /home/vic1707/.config/systemd/user
      mode: 0755
      user:
        name: vic1707
      group:
        name: vic1707
    # Path to manually enable vic1707's systemd units - these are links back to the unit file
    - path: /home/vic1707/.config/systemd/user/default.target.wants
      mode: 0755
      user:
        name: vic1707
      group:
        name: vic1707
    # Path for vic1707's podman quadlets
    - path: /home/vic1707/.config/containers/systemd
      mode: 0755
      user:
        name: vic1707
      group:
        name: vic1707
    # Path for vic1707's custom containerfiles
    - path: /home/vic1707/.config/containers/containerfiles
      mode: 0755
      user:
        name: vic1707
      group:
        name: vic1707

  files:
    #### Backup
    ## {{ if $ENABLE_BACKUP }}
    - path: /etc/sync/paths.txt
      mode: 0400
      contents:
        inline: |
          /var/srv/vic1707/
    - path: /etc/sync/restore.sh
      mode: 0500
      contents:
        local: ./restore.sh
    - path: /etc/selinux/custom-policies/rsync-cifs.te
      mode: 0400
      contents:
        inline: |
          module rsync_cifs 1.0;

          require {
            type rsync_t;
            class capability dac_override;
          }

          #============= rsync_t ==============
          allow rsync_t self:capability dac_override;

    - path: /etc/cifs-credentials
      mode: 0400
      contents:
        inline: |
          username={{ $STORAGEBOX_USER }}
          password={{ $STORAGEBOX_PASS }}
    ## {{ end }} ## $ENABLE_BACKUP
    # enable lingering
    - path: /var/lib/systemd/linger/vic1707

    # Install semanage
    - path: /var/lib/extensions/semanage.raw
      contents:
        source: https://github.com/travier/fedora-sysexts/releases/download/semanage-3.8-1.fc42-42-{{$ARCH}}/semanage-3.8-1.fc42-42-{{$ARCH}}.raw

    # SSH daemon hardening
    - path: /etc/ssh/sshd_config.d/99-hardening.conf
      mode: 0400
      contents:
        inline: |
          Port {{ $SSH_PORT }}
          PermitRootLogin no              # Disallow root SSH logins
          PasswordAuthentication no       # Force key-based auth
          AddressFamily inet              # Binds SSH to IPv4 only
          MaxAuthTries 6                  # Includes ssh-key tries
          MaxSessions 2                   # Max connections per IP
          MaxStartups 2                   # Maximum incoming connection attempts
          LogLevel VERBOSE

    # Require password for sudo (wheel and sudo groups)
    - path: /etc/sudoers.d/99-wheel-sudo-require-password
      mode: 0400
      contents:
        inline: |
          %wheel ALL=(ALL) ALL
          %sudo ALL=(ALL) ALL

    # Disable unnecessary DNS listeners (like LLMNR, mDNS, and stub listener)
    - path: /etc/systemd/resolved.conf.d/99-custom-dns-disable-llmnr-mdns-stublistener.conf
      mode: 0444 # Cannot change
      contents:
        inline: |
          [Resolve]
          # Cloudflare
          DNS=1.1.1.1 1.0.0.1
          # Quad9 & Google DNS
          FallbackDNS=9.9.9.9 8.8.8.8
          # Disables Link-Local Multicast Name Resolution
          LLMNR=no
          # Disables mDNS
          MulticastDNS=no
          # Prevents systemd-resolved from opening port 53 on localhost
          DNSStubListener=no

    # Close all ports (firewall rules)
    - path: /etc/sysconfig/nftables.conf
      overwrite: true
      mode: 0400
      contents:
        inline: |
          table inet filter {
            chain input {
              ## hook into the kernel's INPUT path to filter packets
              type filter hook input priority 0;

              ## DROP everything by default
              policy drop;

              ## Allow loopback (localhost) traffic
              # @typos-ignore
              iif lo accept;

              ## Allow established or related connections
              ct state established, related accept;

              ## Allow SSH
              tcp dport {{ $SSH_PORT }} accept;
              ## Caddy ports
              tcp dport 80 accept;
              tcp dport 443 accept;
            }

            chain forward {
              ## hook into the kernel's FORWARD path to filter packets
              type filter hook forward priority 0;

              ## DROP everything by default
              policy drop;
            }

            chain output {
              ## hook into the kernel's OUTPUT path to filter packets
              type filter hook output priority 0;

              ## ALLOW everything by default
              policy accept;
            }
          }

    # Audit rules
    - path: /etc/audit/rules.d/99-custom.rules
      mode: 0400
      contents:
        inline: |
          # Watch /etc/passwd for write (w) and attribute (a) changes.
          -w /etc/passwd -p wa -k passwd_changes

          # Watch /etc/shadow for write (w) and attribute (a) changes.
          -w /etc/shadow -p wa -k shadow_changes

          # Watch SSH daemon config for changes.
          -w /etc/ssh/sshd_config -p wa -k ssh_config_changes

    # Sysctl hardening
    - path: /etc/sysctl.d/99-hardening.conf
      mode: 0400
      contents:
        inline: |
          # Enable reverse path filtering (prevents IP spoofing).
          net.ipv4.conf.all.rp_filter = 1

          # Restrict access to kernel pointers in /proc (helps mitigate kernel info leaks).
          kernel.kptr_restrict = 2

    # Allow the unprivileged user to bind to port 80 and above
    - path: /etc/sysctl.d/90-unprivileged-ports.conf
      contents:
        inline: |
          net.ipv4.ip_unprivileged_port_start = 80

    ######################
    ## Containers stuff ##
    ######################
    - path: /home/vic1707/.config/containers/systemd/tunnel.network
      mode: 0400
      contents:
        # Options=isolate=true
        inline: |
          [Network]
          NetworkName=tunnel
          Driver=bridge
          IPv6=false
          Subnet=10.89.0.0/26
          Gateway=10.89.0.1
      user:
        name: vic1707
      group:
        name: vic1707

    ## Caddy
    - path: /home/vic1707/.config/containers/containerfiles/caddy.Containerfile
      mode: 0400
      contents:
        local: ./caddy.Containerfile
      user:
        name: vic1707
      group:
        name: vic1707
    - path: /home/vic1707/.config/containers/caddy/Caddyfile
      mode: 0400
      contents:
        local: ./Caddyfile
      user:
        name: vic1707
      group:
        name: vic1707
    - path: /home/vic1707/.config/containers/systemd/caddy.build
      mode: 0400
      contents:
        inline: |
          [Build]
          SetWorkingDirectory=/home/vic1707/.config/containers/containerfiles/
          File=caddy.Containerfile
          ImageTag=localhost/caddy
      user:
        name: vic1707
      group:
        name: vic1707
    - path: /home/vic1707/.config/containers/systemd/caddy.container
      mode: 0400
      contents:
        inline: |
          [Unit]
          Description=Caddy Quadlet
          ConditionPathExists=/run/restore-complete

          [Container]
          Image=caddy.build
          ContainerName=caddy
          Network=tunnel.network
          ReadOnly=true
          DropCapability=ALL
          AddCapability=NET_BIND_SERVICE
          NoNewPrivileges=true
          Environment="TZ=Europe/Paris"
          PublishPort=80:80
          PublishPort=443:443
          Volume=/home/vic1707/.config/containers/caddy/Caddyfile:/etc/caddy/Caddyfile:Z,ro
          Volume=/srv/vic1707/containers/caddy:/data/caddy:Z,rw
          UserNS=keep-id
          # User=vic1707

          [Service]
          Restart=always

          [Install]
          WantedBy=default.target
      user:
        name: vic1707
      group:
        name: vic1707

systemd:
  units:
    # Enable systemd-sysext.service to merge the sysexts on boot
    - name: systemd-sysext.service
      enabled: true

    # Enable firewall rules
    - name: nftables.service
      enabled: true

    # Remove docker starting at boot
    - name: docker.service
      mask: true
    - name: docker.socket
      mask: true

    # Enable the Linux Audit Daemon
    - name: auditd.service
      enabled: true

    # Disable system security services daemon (~only used in enterprise setting)
    - name: sssd.socket
      mask: true
    - name: sssd.service
      mask: true

    # SSH port redirection
    - name: sshd.socket
      dropins:
        - name: 99-sshd-port.conf
          contents: |
            [Socket]
            ListenStream={{ $SSH_PORT }}

    # Replace chronyd with systemd-timesyncd to avoid open UDP port 323
    - name: chronyd.service
      mask: true
    - name: systemd-timesyncd.service
      enabled: true # outbound-only time sync (no open ports)

    # Manage SELinux, waiting for a better solution
    - name: set-se-state.service
      enabled: true
      contents: |
        [Unit]
        Description=Configure SELinux
        After=systemd-sysext.service
        Wants=systemd-sysext.service
        Requires=systemd-sysext.service
        Before=sshd.service

        [Service]
        Type=oneshot 
        RemainAfterExit=yes
        ## Allows sshd to bind to custom port
        ExecStart=/usr/bin/semanage port -a -t ssh_port_t -p tcp {{ $SSH_PORT }}

        [Install]
        WantedBy=multi-user.target

    ## {{ if $ENABLE_BACKUP }}
    #### Backup
    - name: set-rsync-se-state.service
      enabled: true
      contents: |
        [Unit]
        Description=Configure SELinux
        After=set-se-state.service

        [Service]
        Type=oneshot 
        RemainAfterExit=yes
        ExecStart=/usr/bin/setsebool rsync_full_access on
        ExecStart=/bin/bash -c '/usr/bin/checkmodule -M -m -o /tmp/rsync_cifs.mod /etc/selinux/custom-policies/rsync-cifs.te && /usr/bin/semodule_package -o /tmp/rsync_cifs.pp -m /tmp/rsync_cifs.mod && /usr/bin/semodule -i /tmp/rsync_cifs.pp && /usr/bin/rm -f /tmp/rsync_cifs.*'

        [Install]
        WantedBy=multi-user.target
    - name: sync-backup.service
      enabled: true
      contents: |
        [Unit]
        Description=Sync paths to mounted Hetzner Storage Box
        After=sync-restore.service

        [Service]
        Type=oneshot
        ExecStart=/usr/bin/rsync --verbose \
          --archive --recursive \
          --delete \
          --fake-super \
          --log-file=/var/log/sync-to-storagebox.log \
          --files-from=/etc/sync/paths.txt \
          --relative / /var/mnt/storagebox

        [Install]
        WantedBy=multi-user.target

    - name: sync-backup.timer
      enabled: true
      contents: |
        [Unit]
        Description=Periodic sync to mounted Hetzner Storage Box

        [Timer]
        OnUnitActiveSec=3min
        Persistent=true

        [Install]
        WantedBy=timers.target
    - name: sync-restore.service
      enabled: true
      contents: |
        [Unit]
        Description=Restore system from CIFS backup on boot
        After=var-mnt-storagebox.mount

        [Service]
        Type=oneshot
        ExecStart=/etc/sync/restore.sh "/etc/sync/paths.txt" "/var/mnt/storagebox"
        ExecStartPost=/usr/bin/touch /run/restore-complete

        [Install]
        WantedBy=multi-user.target
    - name: var-mnt-storagebox.mount
      enabled: true
      contents: |
        [Unit]
        Description=Mount CIFS Hetzner Storagebox
        After=network-online.target set-rsync-se-state.service
        Requires=network-online.target set-rsync-se-state.service

        [Mount]
        # https://docs.hetzner.com/storage/storage-box/access/access-samba-cifs/#sambacifs
        What=//{{ $STORAGEBOX_USER }}.your-storagebox.de/{{ $STORAGEBOX_USER }}
        Where=/var/mnt/storagebox
        Type=cifs
        Options=credentials=/etc/cifs-credentials,_netdev,vers=3.0

        [Install]
        WantedBy=multi-user.target
    ## {{ else }}
    - name: dummy-restore.service
      enabled: true
      contents: |
        [Unit]
        Description=Dummy fake restore service

        [Service]
        Type=oneshot
        ExecStart=/usr/bin/touch /run/restore-complete

        [Install]
        WantedBy=multi-user.target
    ## {{ end }} ## $ENABLE_BACKUP

passwd:
  users:
    - name: vic1707
      groups: [wheel]
      password_hash: $y$j9T$gPdejaqSri3Aosk3FJhYK0$n5U3M6CCRxwOo.VwK4JdL3.TSaZIZEZEU9FFjJziD/A
      ssh_authorized_keys_local:
        - .ssh/vic1707-telstar.pub

    # Disable default "core" user
    - name: core
      shell: /sbin/nologin
